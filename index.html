<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é­ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ çµ±åˆæœ¬éƒ¨</title>
    <style>
        /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆè¨­å®š */
        body { 
            font-family: 'Hiragino Mincho ProN', 'Yu Mincho', serif; 
            background-color: #0f0f0f; color: #ecf0f1; 
            margin: 0; padding: 0;
            height: 100vh; overflow: hidden; display: flex;
        }
        .col-left { width: 300px; background: #191919; border-right: 4px solid #c0392b; display: flex; flex-direction: column; flex-shrink: 0; }
        .col-center { flex: 1; background: #1e272e; display: flex; flex-direction: column; padding: 20px; min-width: 400px; }
        .col-right { width: 350px; background: #000; border-left: 4px solid #3498db; display: flex; flex-direction: column; flex-shrink: 0; }

        .scroll-area { flex: 1; overflow-y: auto; padding: 15px; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 4px; }

        /* å·¦ã‚«ãƒ©ãƒ  */
        h2 { margin: 0; padding: 15px; font-size: 16px; color: #bdc3c7; border-bottom: 1px solid #333; background: rgba(0,0,0,0.2); }
        .minister-card {
            background: #2d3436; padding: 10px; border-radius: 5px; margin-bottom: 10px;
            display: flex; gap: 10px; align-items: flex-start; border: 1px solid #444; transition: 0.2s;
        }
        .minister-card:hover { border-color: #e74c3c; background: #353b48; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background-color: #555; background-size: cover; flex-shrink: 0; border: 2px solid #777; }
        .minister-info { width: 100%; }
        .minister-name { font-weight: bold; font-size: 14px; margin-bottom: 4px; display: block;}
        .minister-role { font-size: 10px; color: #bdc3c7; background: #000; padding: 2px 5px; border-radius: 3px; margin-left: 5px;}
        .minister-comment { font-size: 12px; color: #ddd; background: #000; padding: 8px; border-radius: 4px; line-height: 1.4; position: relative; }
        .minister-comment::after { content: ""; position: absolute; left: -6px; top: 12px; border-width: 6px 6px 6px 0; border-style: solid; border-color: transparent #000 transparent transparent; }

        /* ä¸­å¤®ã‚«ãƒ©ãƒ  */
        h1 { margin: 0 0 15px 0; font-size: 24px; color: #e74c3c; border-bottom: 2px solid #c0392b; text-align: center; padding-bottom: 10px;}
        .rating-panel {
            background: #2f3640; padding: 10px 20px; border-radius: 8px; margin-bottom: 15px;
            display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .rating-box { text-align: center; }
        .rating-val { font-size: 28px; font-weight: bold; color: #f1c40f; text-shadow: 0 0 10px rgba(241, 196, 15, 0.5); }
        .rating-label { font-size: 11px; color: #95a5a6; }
        .reputation-val { font-size: 20px; font-weight: bold; color: #fff; }

        .status-bar {
            display: flex; justify-content: space-around; background: #2f3640; 
            padding: 10px; border-radius: 5px; margin-bottom: 15px; border: 1px solid #444;
        }
        .stat-val { font-size: 22px; font-weight: bold; color: #fff; }
        .stat-label { font-size: 11px; color: #95a5a6; margin-bottom: 2px; }

        .action-panel { display: flex; gap: 10px; margin-bottom: 15px; }
        .btn {
            flex: 1; border: none; padding: 12px; border-radius: 5px;
            font-weight: bold; cursor: pointer; color: #fff; text-shadow: 1px 1px 0 rgba(0,0,0,0.5);
            transition: 0.1s; display: flex; flex-direction: column; align-items: center;
        }
        .btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { filter: grayscale(100%); cursor: not-allowed; transform: none; }
        .btn-edict { background: linear-gradient(#f1c40f, #d35400); }
        .btn-audit { background: linear-gradient(#3498db, #2980b9); }
        .btn-rumor { background: linear-gradient(#e74c3c, #c0392b); }

        .log-item { background: #2f3640; margin-bottom: 15px; padding: 15px; border-radius: 5px; border-left: 5px solid #e67e22; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .log-header { display: flex; justify-content: space-between; margin-bottom: 5px; }
        .log-title { font-weight: bold; color: #e67e22; font-size: 16px;}
        .log-time { font-size: 11px; color: #95a5a6; }
        .log-desc { font-size: 14px; line-height: 1.6; color: #ddd; margin-bottom: 8px; }
        .log-link { display: inline-block; font-size: 11px; color: #3498db; text-decoration: none; border: 1px solid #3498db; padding: 2px 8px; border-radius: 10px; margin-top: 5px; }

        .btn-reset { background: transparent; border: 1px solid #555; color: #777; padding: 5px; width: 100%; margin-top: 10px; cursor: pointer; font-size: 10px; }
        .btn-reset:hover { border-color: #e74c3c; color: #e74c3c; }

        /* å³ã‚«ãƒ©ãƒ  */
        .tweet { background: #111; padding: 12px; border-bottom: 1px solid #222; display: flex; gap: 10px; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .tweet-icon { width: 36px; height: 36px; border-radius: 50%; background: #555; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
        .tweet-content { flex: 1; }
        .tweet-header { display: flex; justify-content: space-between; margin-bottom: 4px; align-items: center;}
        .tweet-name { font-weight: bold; font-size: 13px; color: #ecf0f1; }
        .tweet-time { font-size: 10px; color: #555; }
        .tweet-text { font-size: 12px; color: #ccc; line-height: 1.4; }
        .tweet-vip .tweet-name { color: #f1c40f; }
        .tweet-vip .tweet-icon { background: linear-gradient(135deg, #8e44ad, #c0392b); border: 2px solid #f1c40f; }

        .change-plus { color: #2ecc71; } .change-minus { color: #e74c3c; }

        /* ç”»åƒå®šç¾© */
        .avatar-æ›¹æ“ { background-image: url('images/caocao.png'); background-color: #c0392b; }
        .avatar-è€å½§ { background-image: url('images/juniku.png'); background-color: #16a085; }
        .avatar-éƒ­å˜‰ { background-image: url('images/kakuka.png'); background-color: #3498db; }
        .avatar-å¸é¦¬æ‡¿ { background-image: url('images/shibai.png'); background-color: #8e44ad; }
        .avatar-è€æ”¸ { background-image: url('images/junyu.png'); background-color: #7f8c8d; }
        .avatar-è³ˆè©¡ { background-image: url('images/kaku.png'); background-color: #2c3e50; }
        .avatar-ç´«é¸ { background-image: url('images/ziran.png'); background-color: #8e44ad; border-color: #f1c40f; }
    </style>
</head>
<body>

    <div class="col-left">
        <h2 style="color:#e74c3c; border-left:5px solid #e74c3c;">çµŒå–¶ä¼šè­°å®¤</h2>
        <div id="members-container" class="scroll-area"></div>
    </div>

    <div class="col-center">
        <h1>é­ãƒ›ãƒ¼ãƒ«ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ çµ±åˆæœ¬éƒ¨</h1>
        <div class="rating-panel">
            <div class="rating-box"><div class="rating-label">çµŒå–¶è©•ä¾¡</div><div id="rating" class="rating-val">---</div></div>
            <div class="rating-box"><div class="rating-label">å¸‚äº•ã®è©•åˆ¤</div><div id="reputation" class="reputation-val">---</div></div>
        </div>

        <div class="status-bar">
            <div class="stat-item"><div class="stat-label">è»è³‡é‡‘</div><div id="funds" class="stat-val">---</div></div>
            <div class="stat-item"><div class="stat-label">å£«æ°—</div><div id="morale" class="stat-val">---</div></div>
            <div class="stat-item"><div class="stat-label">ãƒªã‚¹ã‚¯</div><div id="risk" class="stat-val">---</div></div>
        </div>

        <div class="action-panel">
            <button id="btn-edict" class="btn btn-edict" onclick="sendAction('edict')">ğŸ“œ å‹…å‘½</button>
            <button id="btn-audit" class="btn btn-audit" onclick="sendAction('audit')">âš–ï¸ ç›£æŸ»</button>
            <button id="btn-rumor" class="btn btn-rumor" onclick="sendAction('rumor')">ğŸ”¥ æµè¨€</button>
        </div>
        <div id="loading-msg" style="text-align:center; font-size:12px; color:#aaa; display:none; margin-bottom:10px;">âš¡ å¤©ã®å£°ã‚’å—ä¿¡ä¸­...</div>

        <div id="log-list" class="scroll-area"></div>
        <button class="btn-reset" onclick="resetWorld()">â™»ï¸ ä¸–ç•Œç·šã‚’ãƒªã‚»ãƒƒãƒˆã™ã‚‹</button>
    </div>

    <div class="col-right">
        <h2 style="color:#3498db; border-left:5px solid #3498db;">Wei-tter (Live)</h2>
        <div id="sns-container" class="scroll-area"></div>
    </div>

    <script>
        const MEMBERS = ["æ›¹æ“", "è€å½§", "éƒ­å˜‰", "å¸é¦¬æ‡¿", "è€æ”¸", "è³ˆè©¡", "ç´«é¸"];
        const ROLES = {"æ›¹æ“":"CEO","è€å½§":"CFO","éƒ­å˜‰":"CTO","å¸é¦¬æ‡¿":"ç›£æŸ»","è€æ”¸":"CSO","è³ˆè©¡":"CMO","ç´«é¸":"ç‰¹å‘½"};
    
        let lastSnsJson = "";
    
        const memContainer = document.getElementById('members-container');
        MEMBERS.forEach(name => {
            const div = document.createElement('div');
            div.className = 'minister-card';
            div.innerHTML = `
                <div class="avatar avatar-${name}"></div>
                <div class="minister-info">
                    <div class="minister-name">${name} <span class="minister-role">${ROLES[name]}</span></div>
                    <div id="comment-${name}" class="minister-comment">...</div>
                </div>`;
            memContainer.appendChild(div);
        });
    
        function formatChange(val, type) {
            if(!val) return "";
            let cls = (type === 'risk') ? (val > 0 ? "change-minus" : "change-plus") : (val > 0 ? "change-plus" : "change-minus");
            let sign = val > 0 ? "+" : "";
            return `<span style="font-size:11px; font-weight:bold; margin-left:3px;" class="${cls}">(${sign}${val})</span>`;
        }
    
        // ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¨ç”»é¢æ›´æ–°
        async function updateDashboard() {
            // æ™‚åˆ»ã‚’æ··ãœã‚‹ã“ã¨ã§ãƒ–ãƒ©ã‚¦ã‚¶ã®å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ23:50ç­‰ï¼‰ã‚’å¼·åˆ¶å›é¿
            const ts = new Date().getTime(); 
            
            try {
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—
                const resStatus = await fetch('data/company_status.json?t=' + ts);
                if (!resStatus.ok) throw new Error("Status Load Failed");
                const data = await resStatus.json();
    
                // ã€Œå¤±æ•—ã€ã¨ã„ã†æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ãŸã‚‰ã€ã¾ã ç”Ÿæˆä¸­ã¨ã¿ãªã—ã¦è¡¨ç¤ºã‚’ã‚¹ã‚­ãƒƒãƒ—
                if (data.description === "å¤±æ•—") {
                    console.log("AIãŒç”Ÿæˆä¸­ã€ã¾ãŸã¯å¤±æ•—ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸã€‚");
                    return;
                }
    
                document.getElementById('funds').innerText = data.funds.toLocaleString();
                document.getElementById('morale').innerText = data.morale;
                document.getElementById('risk').innerText = data.risk + '%';
                document.getElementById('rating').innerText = data.rating || "---";
                document.getElementById('reputation').innerText = data.reputation || "---";
    
                if(data.comments) {
                    MEMBERS.forEach(name => {
                        const el = document.getElementById('comment-' + name);
                        if(el && data.comments[name]) el.innerText = data.comments[name];
                    });
                }
    
                if(data.sns) {
                    const currentSnsJson = JSON.stringify(data.sns);
                    if (currentSnsJson !== lastSnsJson) {
                        const snsContainer = document.getElementById('sns-container');
                        snsContainer.innerHTML = "";
                        data.sns.forEach(tweet => {
                            const div = document.createElement('div');
                            div.className = 'tweet' + (tweet.is_vip ? ' tweet-vip' : '');
                            div.innerHTML = `
                                <div class="tweet-icon">${tweet.is_vip ? 'â˜…' : 'ğŸ‘¤'}</div>
                                <div class="tweet-content">
                                    <div class="tweet-header">
                                        <span class="tweet-name">${tweet.name}</span>
                                        <span class="tweet-time">${tweet.timestamp || ""}</span>
                                    </div>
                                    <div class="tweet-text">${tweet.content}</div>
                                </div>`;
                            snsContainer.appendChild(div);
                        });
                        lastSnsJson = currentSnsJson;
                    }
                }
    
                // å±¥æ­´å–å¾—
                const resHistory = await fetch('data/history.json?t=' + ts);
                if (!resHistory.ok) throw new Error("History Load Failed");
                const hData = await resHistory.json();
                
                const list = document.getElementById('log-list');
                list.innerHTML = "";
                hData.forEach(item => {
                    if(item.description === "å¤±æ•—") return; // å¤±æ•—ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ãªã„
                    const div = document.createElement('div');
                    div.className = 'log-item';
                    let changes = "";
                    if(item.changes) {
                        if(item.changes.funds) changes += `é‡‘${formatChange(item.changes.funds,'funds')} `;
                        if(item.changes.morale) changes += `å£«${formatChange(item.changes.morale,'morale')} `;
                        if(item.changes.risk) changes += `å±${formatChange(item.changes.risk,'risk')} `;
                    }
                    div.innerHTML = `
                        <div class="log-header"><span class="log-title">âš¡ ${item.title}</span><span class="log-time">${item.timestamp}</span></div>
                        <div class="log-desc">
                            <span style="background:#444; color:#fff; padding:1px 5px; border-radius:3px; font-size:10px; margin-right:5px;">${item.proposer}</span>
                            ${item.description}
                            <div>${item.news_url ? `<a href="${item.news_url}" target="_blank" class="log-link">ğŸ”— é–¢é€£ãƒ‹ãƒ¥ãƒ¼ã‚¹</a>` : ""}</div>
                        </div>
                        <div style="font-size:12px; margin-top:5px; border-top:1px dashed #444; padding-top:5px;">${changes}</div>`;
                    list.appendChild(div);
                });
    
            } catch (e) {
                console.log("èª­ã¿è¾¼ã¿å¾…æ©Ÿä¸­...");
            }
        }
    
        async function sendAction(type) {
            // ãƒˆãƒ¼ã‚¯ãƒ³ã‚’åˆ†å‰²ã—ã¦GitHubã®æ¤œçŸ¥ã‚’å›é¿
            const p1 = "ghp_neqY4UXxHhPLaoF";
            const p2 = "SW2uVPdi7suYX2A2B77Yz"; // å¤§æ–‡å­—ã®Pã‚’å°æ–‡å­—ã«ä¿®æ­£
            const TOKEN = p1 + p2;
    
            const GITHUB_USER = "NATTO-FIVE";
            const REPO_NAME = "sangoku-sns";
            const url = `https://api.github.com/repos/${GITHUB_USER}/${REPO_NAME}/actions/workflows/trigger_action.yml/dispatches`;
    
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ref: 'main', inputs: { action_type: type } })
                });
    
                if (response.ok) {
                    alert(`ã€å¤©ã®å£°ã€‘ã‚’é€ä¿¡ã—ã¾ã—ãŸã€‚åæ˜ ã¾ã§æ•°åˆ†ãŠå¾…ã¡ãã ã•ã„ã€‚`);
                } else {
                    alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒˆãƒ¼ã‚¯ãƒ³ã®æœŸé™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }
    
        function resetWorld() { if(confirm("ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) fetch('/api/reset', { method: 'POST' }).then(r=>{ if(r.ok) updateDashboard(); }); }
    
        // åˆå›å®Ÿè¡Œ
        updateDashboard();
        // 30ç§’é–“éš”ã§ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ†ã‚¹ãƒˆã®ãŸã‚å°‘ã—æ—©ã‚ã¾ã—ãŸï¼‰
        // setInterval(updateDashboard, 600000); // 10åˆ†
        setInterval(updateDashboard, 10000); // 10sec
    </script>
</body>
</html>